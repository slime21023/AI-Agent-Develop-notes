# Planning 設計模式

目標是讓 AI 代理能夠有效地處理複雜任務，透過定義清晰目標、分解任務、利用結構化輸出，並具備迭代和適應能力。

## 定義總體目標與任務分解 (Defining the Overall Goal and Breaking Down a Task)

**明確目標**：AI 代理需要一個簡潔明確的目標來指導其規劃和行動。目標越清晰，代理（及人類協作者）越能專注於達成正確的結果。

> 將模糊的「生成 3 天旅遊行程」細化為包含航班、飯店、活動建議的完整行程。

**任務分解 (Task Decomposition)**：將大型或複雜的任務分解成更小、以目標為導向的子任務，使其更易於管理。

> 旅遊行程 -> 預訂機票、預訂飯店、租車、個性化推薦。

**優點**：

*   每個子任務可由專門的代理或流程處理。
*   便於模組化和增量增強（例如，稍後添加美食推薦代理）。
*   協調代理（下游代理）可以將各子任務結果匯集成有組織性的最終輸出。

## 利用結構化輸出 (Structured output)

**目的**：讓大型語言模型 (LLM) 生成結構化輸出（如 JSON），以便下游代理或服務更容易解析和處理。

**重要性**：在多代理環境中尤其有用，可以在收到規劃輸出後觸發相應的任務執行。

**實現**：使用 Pydantic 等工具定義數據模型 (如 `TravelPlan`, `TravelSubTask`)，並要求 LLM 以指定格式（如 JSON）回應。

> 程式碼展示了如何定義模型、向 LLM 請求 JSON 輸出，並將子任務指派給特定的代理類型。

## 規劃代理與多代理協調 (Planning Agent with Multi-Agent Orchestration)

**規劃代理的角色**：
1.  接收使用者請求。
2.  基於系統提示（包含可用代理資訊）生成結構化的計劃（分解子任務並指派代理）。
3.  參考代理註冊表 (Agent Registry) 中各代理及其提供的工具/功能。
4.  根據子任務數量，將訊息直接路由給專門代理（單任務）或透過群聊管理器協調多個代理（多任務）。
5.  總結最終生成的計劃。

**輸出應用**：生成的結構化輸出（如 JSON）可以直接用於將任務路由到 `assigned_agent`，並最終向使用者匯總結果。

## 迭代規劃 (Iterative Planning)

*   **概念**：規劃並非總是線性的。某些任務需要反覆或重新規劃。
*   **觸發條件**：
    *   一個子任務的結果影響下一個子任務（例如，發現非預期的數據格式）。
    *   使用者反饋（例如，使用者決定更換航班時間）。
*   **優點**：確保最終解決方案能適應現實世界的限制和不斷變化的使用者偏好。
*   **實現**：將使用者歷史記錄、當前計劃等資訊傳遞給規劃代理，使其能夠進行重新規劃。

### **總結**

*   本文件展示了如何創建一個可以動態選擇可用代理的規劃器。
*   規劃器的輸出會分解任務並指派代理執行（假設代理已具備所需工具）。
*   可以結合其他模式（如反思 Reflection、摘要 Summarizer、輪詢聊天 Round Robin Chat）進一步自訂。

### **關鍵學習點**

*   為 AI 代理設定清晰的總體目標。
*   將複雜任務分解為可管理的子任務並排序。
*   為代理配備合適工具，決定使用時機，並處理意外情況。
*   評估子任務結果，衡量績效，並迭代行動以改進最終輸出。